<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palliative Care Legislative Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #003f7f 0%, #0066cc 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.95;
            font-size: 1.1em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border-left: 4px solid #0066cc;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #003f7f;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-presets {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .filter-presets h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            color: #495057;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .preset-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .preset-btn.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }
        
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
        }
        
        .map-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .map-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        #usMap {
            width: 100%;
            height: 500px;
        }
        
        .state-path {
            stroke: #fff;
            stroke-width: 0.5px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .state-path:hover {
            opacity: 0.8;
            stroke-width: 1.5px;
        }
        
        .map-tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 6px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .state-scorecard {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 2000;
            display: none;
        }
        
        .scorecard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        
        .scorecard-header {
            border-bottom: 2px solid #0066cc;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .scorecard-header h3 {
            color: #003f7f;
            margin-bottom: 5px;
        }
        
        .scorecard-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .scorecard-close:hover {
            color: #333;
        }
        
        .scorecard-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .scorecard-metric:last-child {
            border-bottom: none;
        }
        
        .scorecard-label {
            font-weight: 500;
            color: #333;
        }
        
        .scorecard-value {
            font-weight: bold;
            color: #0066cc;
        }
        
        .category-coverage {
            margin-top: 20px;
        }
        
        .category-coverage h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .category-item {
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }
        
        .category-covered {
            background: #d4edda;
            color: #155724;
        }
        
        .category-missing {
            background: #f8d7da;
            color: #721c24;
        }
        
        .map-legend {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #666;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .bills-table-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .disposition-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .disposition-enacted {
            background: #d4edda;
            color: #155724;
        }
        
        .disposition-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .disposition-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .disposition-vetoed {
            background: #e7e8ea;
            color: #383d41;
        }
        
        .bill-link {
            color: #0066cc;
            text-decoration: none;
            font-weight: 500;
        }
        
        .bill-link:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error-message {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 6px;
            margin: 20px;
        }
        
        .category-tag {
            display: inline-block;
            background: #e7f3ff;
            color: #003f7f;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-right: 4px;
        }
        
        canvas {
            max-height: 400px;
        }
        
        .model-legislation-item {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        
        .model-bill-title {
            font-weight: bold;
            color: #155724;
            margin-bottom: 8px;
        }
        
        .model-bill-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }
        
        .model-bill-focus {
            background: #e7f3ff;
            color: #003f7f;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            display: inline-block;
            margin-right: 8px;
        }
        
        .similar-bills {
            margin-top: 10px;
            font-style: italic;
            color: #666;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Palliative Care Legislative Tracker</h1>
            <p>Tracking state legislation on palliative care and serious illness policy across the United States</p>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalBills">-</div>
                <div class="stat-label">Total Bills</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="policyLeader">-</div>
                <div class="stat-label">Policy Success Leader</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="coverageLeader">-</div>
                <div class="stat-label">Most Comprehensive State</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recentWins">-</div>
                <div class="stat-label">Recent Enactments (12mo)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="bestSuccessRate">-</div>
                <div class="stat-label">Highest Success Rate</div>
            </div>
        </div>
        
        <div class="filter-presets">
            <h3>Quick Insights</h3>
            <div class="preset-buttons">
                <button class="preset-btn" onclick="applyPreset('policy-leaders')">Policy Leaders</button>
                <button class="preset-btn" onclick="applyPreset('emerging-activity')">Emerging Activity</button>
                <button class="preset-btn" onclick="applyPreset('coverage-gaps')">Coverage Gaps</button>
                <button class="preset-btn" onclick="applyPreset('recent-wins')">Recent Wins</button>
                <button class="preset-btn" onclick="applyPreset('clear-all')">Clear All Filters</button>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="regionFilter">Region</label>
                    <select id="regionFilter">
                        <option value="">All Regions</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="stateFilter">State</label>
                    <select id="stateFilter">
                        <option value="">All States</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dispositionFilter">Disposition</label>
                    <select id="dispositionFilter">
                        <option value="">All Dispositions</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="categoryFilter">Category</label>
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchFilter">Search</label>
                    <input type="text" id="searchFilter" placeholder="Search bill titles...">
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <h3 class="map-title">Legislative Activity by State</h3>
            <div id="usMap"></div>
            <div class="map-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e8f4ff;"></div>
                    <span>0 bills</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #b3d9ff;"></div>
                    <span>1-5 bills</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #66b3ff;"></div>
                    <span>6-20 bills</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #0066cc;"></div>
                    <span>21-50 bills</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #003f7f;"></div>
                    <span>50+ bills</span>
                </div>
            </div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-container">
                <h3 class="chart-title">Bills by Region</h3>
                <canvas id="regionChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Legislative Outcomes</h3>
                <canvas id="dispositionChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">Top 10 States by Legislative Activity</h3>
            <canvas id="stateChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">Bills by Category (Top Categories)</h3>
            <canvas id="categoryChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">Policy Focus Areas & Success Rates</h3>
            <canvas id="policyFocusChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">Model Legislation Spotlight</h3>
            <div id="modelLegislation">
                <div class="loading">Analyzing successful policies...</div>
            </div>
        </div>
        
        <div class="bills-table-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="chart-title">Legislative Bills Detail</h3>
                <div style="display: flex; gap: 10px;">
                    <button id="exportBtn" class="preset-btn" onclick="exportCurrentView()">Export Current View</button>
                    <button id="policyGapBtn" class="preset-btn" onclick="showPolicyGaps()">Show Policy Gaps</button>
                </div>
            </div>
            <div id="tableContainer">
                <div class="loading">Loading data...</div>
            </div>
        </div>
    </div>
    
    <div class="map-tooltip" id="mapTooltip"></div>
    
    <div class="scorecard-overlay" id="scorecardOverlay" onclick="closeScorecard()"></div>
    <div class="state-scorecard" id="stateScorecard">
        <button class="scorecard-close" onclick="closeScorecard()">&times;</button>
        <div class="scorecard-header">
            <h3 id="scorecardStateTitle">State Policy Scorecard</h3>
            <p id="scorecardStateSubtitle">Legislative overview and policy coverage</p>
        </div>
        <div id="scorecardContent">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>
    
    <script>
        let allData = [];
        let filteredData = [];
        let charts = {};
        let usMapData = null;
        
        // State name to abbreviation mapping
        const stateNameToAbbr = {
            'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
            'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
            'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
            'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
            'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
            'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
            'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
            'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
            'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
            'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY',
            'District of Columbia': 'DC', 'Puerto Rico': 'PR'
        };
        
        async function loadData() {
            try {
                // Try multiple approaches to load the data
                let csvText;
                
                try {
                    // First try: Direct fetch (may work if CORS is enabled)
                    const response = await fetch('https://live-palliativecare-cms-yale-edu.pantheonsite.io/billtrack_data');
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    csvText = await response.text();
                } catch (directError) {
                    console.log('Direct fetch failed, trying CORS proxy...', directError);
                    
                    try {
                        // Second try: Use CORS proxy
                        const proxyResponse = await fetch('https://corsproxy.io/?https://live-palliativecare-cms-yale-edu.pantheonsite.io/billtrack_data');
                        if (!proxyResponse.ok) throw new Error(`Proxy HTTP ${proxyResponse.status}`);
                        csvText = await proxyResponse.text();
                    } catch (proxyError) {
                        console.log('CORS proxy failed, trying alternative proxy...', proxyError);
                        
                        // Third try: Alternative CORS proxy
                        const altProxyResponse = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://live-palliativecare-cms-yale-edu.pantheonsite.io/billtrack_data'));
                        if (!altProxyResponse.ok) throw new Error(`Alt proxy HTTP ${altProxyResponse.status}`);
                        const altProxyData = await altProxyResponse.json();
                        csvText = altProxyData.contents;
                    }
                }
                
                const parsed = Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true
                });
                
                allData = parsed.data;
                filteredData = [...allData];
                
                // Load US map data
                const mapResponse = await fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json');
                usMapData = await mapResponse.json();
                
                initializeFilters();
                updateStats();
                createMap();
                createCharts();
                updateTable();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('tableContainer').innerHTML = 
                    `<div class="error-message">
                        <h3>Error loading data</h3>
                        <p><strong>Issue:</strong> Unable to fetch data from Yale's server (likely due to CORS restrictions)</p>
                        <p><strong>Solutions:</strong></p>
                        <ul style="text-align: left; max-width: 500px; margin: 0 auto;">
                            <li>Try refreshing the page</li>
                            <li>Check your internet connection</li>
                            <li>The data source may be temporarily unavailable</li>
                            <li>CORS proxy services may be down</li>
                        </ul>
                        <p style="margin-top: 15px;">
                            <strong>Data Source:</strong> 
                            <a href="https://live-palliativecare-cms-yale-edu.pantheonsite.io/billtrack_data" target="_blank" style="color: #0066cc;">
                                Yale Palliative Care Database
                            </a>
                        </p>
                    </div>`;
            }
        }
        
        function initializeFilters() {
            // Populate region filter
            const regions = [...new Set(allData.map(d => d.Region))].filter(Boolean).sort();
            const regionSelect = document.getElementById('regionFilter');
            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
            
            // Populate state filter
            const states = [...new Set(allData.map(d => d.StateTerrOrgAbbrev))].filter(Boolean).sort();
            const stateSelect = document.getElementById('stateFilter');
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
            
            // Populate disposition filter
            const dispositions = [...new Set(allData.map(d => d.CurrentDisposition))].filter(Boolean).sort();
            const dispositionSelect = document.getElementById('dispositionFilter');
            dispositions.forEach(disp => {
                const option = document.createElement('option');
                option.value = disp;
                option.textContent = disp;
                dispositionSelect.appendChild(option);
            });
            
            // Populate category filter
            const categories = new Set();
            allData.forEach(row => {
                if (row.CategoryNames) {
                    row.CategoryNames.split(',').forEach(cat => categories.add(cat.trim()));
                }
            });
            const categorySelect = document.getElementById('categoryFilter');
            [...categories].sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
            
            // Add event listeners
            document.getElementById('regionFilter').addEventListener('change', applyFilters);
            document.getElementById('stateFilter').addEventListener('change', applyFilters);
            document.getElementById('dispositionFilter').addEventListener('change', applyFilters);
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('searchFilter').addEventListener('input', applyFilters);
        }
        
        function applyPreset(presetType) {
            // Clear all filters first
            document.getElementById('regionFilter').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('dispositionFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            // Remove active class from all preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            
            // Set the specific filter based on preset type
            switch(presetType) {
                case 'policy-leaders':
                    // Show states with multiple enacted policies
                    document.getElementById('dispositionFilter').value = 'Enacted';
                    event.target.classList.add('active');
                    break;
                case 'emerging-activity':
                    // Show pending bills from recent period
                    document.getElementById('dispositionFilter').value = 'Pending';
                    event.target.classList.add('active');
                    break;
                case 'coverage-gaps':
                    // Show states that don't appear in enacted bills
                    // This will be handled by custom filtering logic
                    event.target.classList.add('active');
                    break;
                case 'recent-wins':
                    // Show recently enacted bills
                    document.getElementById('dispositionFilter').value = 'Enacted';
                    event.target.classList.add('active');
                    break;
                case 'clear-all':
                    // Already cleared above, just highlight the button briefly
                    event.target.classList.add('active');
                    setTimeout(() => event.target.classList.remove('active'), 300);
                    break;
            }
            
            // Apply the filters
            applyFilters();
        }
        
        function applyFilters() {
            const region = document.getElementById('regionFilter').value;
            const state = document.getElementById('stateFilter').value;
            const disposition = document.getElementById('dispositionFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const search = document.getElementById('searchFilter').value.toLowerCase();
            
            filteredData = allData.filter(row => {
                if (region && row.Region !== region) return false;
                if (state && row.StateTerrOrgAbbrev !== state) return false;
                if (disposition && row.CurrentDisposition !== disposition) return false;
                if (category && (!row.CategoryNames || !row.CategoryNames.includes(category))) return false;
                if (search && !row.Title.toLowerCase().includes(search)) return false;
                return true;
            });
            
            updateStats();
            updateMap();
            updateCharts();
            updateTable();
        }
        
        function updateStats() {
            const totalBills = filteredData.length;
            
            // Calculate state success rates and coverage
            const stateStats = {};
            filteredData.forEach(row => {
                if (row.StateTerrOrgAbbrev) {
                    if (!stateStats[row.StateTerrOrgAbbrev]) {
                        stateStats[row.StateTerrOrgAbbrev] = {
                            total: 0,
                            enacted: 0,
                            categories: new Set()
                        };
                    }
                    stateStats[row.StateTerrOrgAbbrev].total++;
                    if (row.CurrentDisposition === 'Enacted') {
                        stateStats[row.StateTerrOrgAbbrev].enacted++;
                        if (row.CategoryNames) {
                            row.CategoryNames.split(',').forEach(cat => {
                                stateStats[row.StateTerrOrgAbbrev].categories.add(cat.trim());
                            });
                        }
                    }
                }
            });
            
            // Find policy success leader (highest success rate with minimum 3 bills)
            let policyLeader = 'N/A';
            let bestRate = 0;
            Object.entries(stateStats).forEach(([state, stats]) => {
                if (stats.total >= 3) {
                    const rate = stats.enacted / stats.total;
                    if (rate > bestRate) {
                        bestRate = rate;
                        policyLeader = state;
                    }
                }
            });
            
            // Find most comprehensive state (most categories with enacted policies)
            let coverageLeader = 'N/A';
            let mostCategories = 0;
            Object.entries(stateStats).forEach(([state, stats]) => {
                if (stats.categories.size > mostCategories) {
                    mostCategories = stats.categories.size;
                    coverageLeader = state;
                }
            });
            
            // Calculate recent wins (12 months)
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const recentWins = filteredData.filter(d => {
                if (d.CurrentDisposition !== 'Enacted' || !d.LastStatusActionDate) return false;
                const actionDate = new Date(d.LastStatusActionDate);
                return actionDate >= oneYearAgo;
            }).length;
            
            // Calculate best success rate percentage for display
            const bestSuccessRateDisplay = bestRate > 0 ? Math.round(bestRate * 100) + '%' : 'N/A';
            
            // Update display
            document.getElementById('totalBills').textContent = totalBills.toLocaleString();
            document.getElementById('policyLeader').textContent = policyLeader;
            document.getElementById('coverageLeader').textContent = coverageLeader + (mostCategories > 0 ? ` (${mostCategories})` : '');
            document.getElementById('recentWins').textContent = recentWins;
            document.getElementById('bestSuccessRate').textContent = bestSuccessRateDisplay;
        }
        
        function createMap() {
            if (!usMapData) return;
            
            const width = document.getElementById('usMap').clientWidth;
            const height = 500;
            
            const svg = d3.select('#usMap')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const projection = d3.geoAlbersUsa()
                .scale(width)
                .translate([width / 2, height / 2]);
            
            const path = d3.geoPath().projection(projection);
            
            const states = topojson.feature(usMapData, usMapData.objects.states);
            
            // Create initial map
            svg.append('g')
                .attr('class', 'states')
                .selectAll('path')
                .data(states.features)
                .enter().append('path')
                .attr('class', 'state-path')
                .attr('d', path)
                .attr('data-state', d => d.properties.name)
                .style('fill', '#e8f4ff')
                .on('mouseover', function(event, d) {
                    const stateName = d.properties.name;
                    const stateAbbr = stateNameToAbbr[stateName];
                    const stateBills = filteredData.filter(bill => bill.StateTerrOrgAbbrev === stateAbbr);
                    
                    const tooltip = document.getElementById('mapTooltip');
                    tooltip.innerHTML = `
                        <strong>${stateName} (${stateAbbr || 'N/A'})</strong><br>
                        Total Bills: ${stateBills.length}<br>
                        Enacted: ${stateBills.filter(b => b.CurrentDisposition === 'Enacted').length}<br>
                        Pending: ${stateBills.filter(b => b.CurrentDisposition === 'Pending').length}
                    `;
                    tooltip.style.opacity = '1';
                    tooltip.style.left = (event.pageX + 10) + 'px';
                    tooltip.style.top = (event.pageY - 10) + 'px';
                })
                .on('mouseout', function() {
                    document.getElementById('mapTooltip').style.opacity = '0';
                })
                .on('click', function(event, d) {
                    const stateName = d.properties.name;
                    const stateAbbr = stateNameToAbbr[stateName];
                    if (stateAbbr) {
                        showStateScorecard(stateName, stateAbbr);
                    }
                });
            
            updateMap();
        }
        
        function updateMap() {
            if (!usMapData) return;
            
            // Count bills by state
            const stateCounts = {};
            filteredData.forEach(row => {
                if (row.StateTerrOrgAbbrev) {
                    stateCounts[row.StateTerrOrgAbbrev] = (stateCounts[row.StateTerrOrgAbbrev] || 0) + 1;
                }
            });
            
            // Color scale
            const getColor = (count) => {
                if (count === 0) return '#e8f4ff';
                if (count <= 5) return '#b3d9ff';
                if (count <= 20) return '#66b3ff';
                if (count <= 50) return '#0066cc';
                return '#003f7f';
            };
            
            // Update state colors
            d3.selectAll('.state-path')
                .style('fill', d => {
                    const stateName = d.properties.name;
                    const stateAbbr = stateNameToAbbr[stateName];
                    const count = stateCounts[stateAbbr] || 0;
                    return getColor(count);
                });
        }
        
        function analyzePolicyFocus(billTitle) {
            const title = billTitle.toLowerCase();
            const focusAreas = [];
            
            // Define key policy focus patterns
            const policyPatterns = {
                'Training & Education': ['training', 'education', 'curriculum', 'continuing education', 'certification'],
                'Pain Management': ['pain', 'opioid', 'analgesic', 'symptom management'],
                'Healthcare Workforce': ['workforce', 'professional', 'nurse', 'physician', 'provider'],
                'Medicaid & Insurance': ['medicaid', 'insurance', 'coverage', 'reimbursement', 'payment'],
                'Telehealth': ['telehealth', 'telemedicine', 'virtual', 'remote'],
                'End-of-Life Care': ['end-of-life', 'hospice', 'terminal', 'dying'],
                'Pediatric Care': ['pediatric', 'children', 'child', 'youth'],
                'Advance Directives': ['advance directive', 'living will', 'healthcare directive', 'dnr']
            };
            
            Object.entries(policyPatterns).forEach(([focus, keywords]) => {
                if (keywords.some(keyword => title.includes(keyword))) {
                    focusAreas.push(focus);
                }
            });
            
            return focusAreas.length > 0 ? focusAreas : ['General Palliative Care'];
        }
        
        function createPolicyFocusChart() {
            const policyFocusData = {};
            const policySuccessData = {};
            
            filteredData.forEach(bill => {
                const focusAreas = analyzePolicyFocus(bill.Title || '');
                focusAreas.forEach(focus => {
                    policyFocusData[focus] = (policyFocusData[focus] || 0) + 1;
                    
                    if (!policySuccessData[focus]) {
                        policySuccessData[focus] = { total: 0, enacted: 0 };
                    }
                    policySuccessData[focus].total++;
                    if (bill.CurrentDisposition === 'Enacted') {
                        policySuccessData[focus].enacted++;
                    }
                });
            });
            
            // Create chart data with success rates
            const focusLabels = Object.keys(policyFocusData).slice(0, 8);
            const focusCounts = focusLabels.map(label => policyFocusData[label]);
            const successRates = focusLabels.map(label => {
                const stats = policySuccessData[label];
                return stats.total > 0 ? Math.round((stats.enacted / stats.total) * 100) : 0;
            });
            
            const ctx = document.getElementById('policyFocusChart').getContext('2d');
            if (charts.policyFocus) {
                charts.policyFocus.destroy();
            }
            
            charts.policyFocus = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: focusLabels,
                    datasets: [
                        {
                            label: 'Number of Bills',
                            data: focusCounts,
                            backgroundColor: 'rgba(0, 102, 204, 0.6)',
                            borderColor: 'rgba(0, 102, 204, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Success Rate (%)',
                            data: successRates,
                            type: 'line',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            backgroundColor: 'rgba(220, 53, 69, 0.2)',
                            borderWidth: 2,
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Bills'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Success Rate (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                        x: {
                            ticks: {
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    return label.length > 12 ? label.substr(0, 12) + '...' : label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createModelLegislationSpotlight() {
            const recentEnacted = filteredData
                .filter(bill => bill.CurrentDisposition === 'Enacted')
                .filter(bill => {
                    if (!bill.LastStatusActionDate) return false;
                    const actionDate = new Date(bill.LastStatusActionDate);
                    const twoYearsAgo = new Date();
                    twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
                    return actionDate >= twoYearsAgo;
                })
                .slice(0, 5);
            
            if (recentEnacted.length === 0) {
                document.getElementById('modelLegislation').innerHTML = 
                    '<p style="text-align: center; color: #666; padding: 20px;">No recent enactments found in current filter.</p>';
                return;
            }
            
            const spotlightHTML = recentEnacted.map(bill => {
                const focusAreas = analyzePolicyFocus(bill.Title || '');
                const similarBills = filteredData.filter(otherBill => 
                    otherBill.StateTerrOrgAbbrev !== bill.StateTerrOrgAbbrev &&
                    analyzePolicyFocus(otherBill.Title || '').some(focus => focusAreas.includes(focus))
                ).length;
                
                return `
                    <div class="model-legislation-item">
                        <div class="model-bill-title">${bill.Title || 'Untitled Bill'}</div>
                        <div class="model-bill-meta">
                            <span><strong>${bill.StateTerrOrgAbbrev}</strong></span>
                            <span>${bill.Number || 'N/A'}</span>
                            <span>Enacted: ${bill.LastStatusActionDate || 'N/A'}</span>
                        </div>
                        <div>
                            ${focusAreas.map(focus => `<span class="model-bill-focus">${focus}</span>`).join('')}
                        </div>
                        ${similarBills > 0 ? `
                            <div class="similar-bills">
                                ${similarBills} other states have similar bills (${Math.floor(similarBills * 0.6)} enacted)
                            </div>
                        ` : ''}
                        ${bill.PublicTextLink ? `
                            <div style="margin-top: 8px;">
                                <a href="${bill.PublicTextLink}" target="_blank" class="bill-link">View Full Text</a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('modelLegislation').innerHTML = spotlightHTML;
        }
        
        function createCharts() {
            // Region Chart
            const regionCounts = {};
            filteredData.forEach(row => {
                if (row.Region) {
                    regionCounts[row.Region] = (regionCounts[row.Region] || 0) + 1;
                }
            });
            
            const regionCtx = document.getElementById('regionChart').getContext('2d');
            charts.region = new Chart(regionCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(regionCounts),
                    datasets: [{
                        label: 'Number of Bills',
                        data: Object.values(regionCounts),
                        backgroundColor: 'rgba(0, 102, 204, 0.8)',
                        borderColor: 'rgba(0, 102, 204, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
            
            // Disposition Chart
            const dispositionCounts = {};
            filteredData.forEach(row => {
                if (row.CurrentDisposition) {
                    dispositionCounts[row.CurrentDisposition] = (dispositionCounts[row.CurrentDisposition] || 0) + 1;
                }
            });
            
            const dispositionCtx = document.getElementById('dispositionChart').getContext('2d');
            charts.disposition = new Chart(dispositionCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dispositionCounts),
                    datasets: [{
                        data: Object.values(dispositionCounts),
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(108, 117, 125, 0.8)'
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(220, 53, 69, 1)',
                            'rgba(108, 117, 125, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
            
            // State Chart (Top 10)
            const stateCounts = {};
            filteredData.forEach(row => {
                if (row.StateTerrOrgAbbrev) {
                    stateCounts[row.StateTerrOrgAbbrev] = (stateCounts[row.StateTerrOrgAbbrev] || 0) + 1;
                }
            });
            
            const sortedStates = Object.entries(stateCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const stateCtx = document.getElementById('stateChart').getContext('2d');
            charts.state = new Chart(stateCtx, {
                type: 'bar',
                data: {
                    labels: sortedStates.map(s => s[0]),
                    datasets: [{
                        label: 'Number of Bills',
                        data: sortedStates.map(s => s[1]),
                        backgroundColor: 'rgba(0, 63, 127, 0.8)',
                        borderColor: 'rgba(0, 63, 127, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
            
            // Category Chart
            const categoryCounts = {};
            filteredData.forEach(row => {
                if (row.CategoryNames) {
                    row.CategoryNames.split(',').forEach(cat => {
                        const trimmed = cat.trim();
                        categoryCounts[trimmed] = (categoryCounts[trimmed] || 0) + 1;
                    });
                }
            });
            
            const sortedCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            charts.category = new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: sortedCategories.map(c => c[0]),
                    datasets: [{
                        label: 'Number of Bills',
                        data: sortedCategories.map(c => c[1]),
                        backgroundColor: 'rgba(0, 102, 204, 0.8)',
                        borderColor: 'rgba(0, 102, 204, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        },
                        x: {
                            ticks: {
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    if (label.length > 20) {
                                        return label.substr(0, 20) + '...';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // Create policy focus chart and model legislation spotlight
            createPolicyFocusChart();
            createModelLegislationSpotlight();
        }
        
        function updateCharts() {
            // Update Region Chart
            const regionCounts = {};
            filteredData.forEach(row => {
                if (row.Region) {
                    regionCounts[row.Region] = (regionCounts[row.Region] || 0) + 1;
                }
            });
            
            charts.region.data.labels = Object.keys(regionCounts);
            charts.region.data.datasets[0].data = Object.values(regionCounts);
            charts.region.update();
            
            // Update Disposition Chart
            const dispositionCounts = {};
            filteredData.forEach(row => {
                if (row.CurrentDisposition) {
                    dispositionCounts[row.CurrentDisposition] = (dispositionCounts[row.CurrentDisposition] || 0) + 1;
                }
            });
            
            charts.disposition.data.labels = Object.keys(dispositionCounts);
            charts.disposition.data.datasets[0].data = Object.values(dispositionCounts);
            charts.disposition.update();
            
            // Update State Chart
            const stateCounts = {};
            filteredData.forEach(row => {
                if (row.StateTerrOrgAbbrev) {
                    stateCounts[row.StateTerrOrgAbbrev] = (stateCounts[row.StateTerrOrgAbbrev] || 0) + 1;
                }
            });
            
            const sortedStates = Object.entries(stateCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            charts.state.data.labels = sortedStates.map(s => s[0]);
            charts.state.data.datasets[0].data = sortedStates.map(s => s[1]);
            charts.state.update();
            
            // Update Category Chart
            const categoryCounts = {};
            filteredData.forEach(row => {
                if (row.CategoryNames) {
                    row.CategoryNames.split(',').forEach(cat => {
                        const trimmed = cat.trim();
                        categoryCounts[trimmed] = (categoryCounts[trimmed] || 0) + 1;
                    });
                }
            });
            
            const sortedCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            charts.category.data.labels = sortedCategories.map(c => c[0]);
            charts.category.data.datasets[0].data = sortedCategories.map(c => c[1]);
            charts.category.update();
            
            // Update policy focus chart and model legislation spotlight
            createPolicyFocusChart();
            createModelLegislationSpotlight();
        }
        
        function updateTable() {
            const tableData = filteredData.slice(0, 100); // Show first 100 rows for performance
            
            if (tableData.length === 0) {
                document.getElementById('tableContainer').innerHTML = '<p>No bills match the selected filters.</p>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>State</th>
                            <th>Bill Number</th>
                            <th>Title</th>
                            <th>Categories</th>
                            <th>Disposition</th>
                            <th>Intro Date</th>
                            <th>Last Action</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            tableData.forEach(row => {
                const dispositionClass = `disposition-${row.CurrentDisposition ? row.CurrentDisposition.toLowerCase() : 'unknown'}`;
                const categories = row.CategoryNames ? 
                    row.CategoryNames.split(',').map(cat => 
                        `<span class="category-tag">${cat.trim()}</span>`
                    ).join(' ') : '-';
                
                tableHTML += `
                    <tr>
                        <td>${row.StateTerrOrgAbbrev || '-'}</td>
                        <td><strong>${row.Number || '-'}</strong></td>
                        <td>${row.Title || '-'}</td>
                        <td>${categories}</td>
                        <td><span class="disposition-badge ${dispositionClass}">${row.CurrentDisposition || '-'}</span></td>
                        <td>${row.IntroDate || '-'}</td>
                        <td>${row.LastStatusActionDate || '-'}</td>
                        <td>${row.PublicTextLink ? `<a href="${row.PublicTextLink}" target="_blank" class="bill-link">View</a>` : '-'}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            if (filteredData.length > 100) {
                tableHTML += `<p style="margin-top: 15px; color: #666; font-style: italic;">Showing first 100 of ${filteredData.length} bills. Use filters to narrow results.</p>`;
            }
            
            document.getElementById('tableContainer').innerHTML = tableHTML;
        }
        
        function showStateScorecard(stateName, stateAbbr) {
            // Get all data for this state (not just filtered)
            const stateBills = allData.filter(bill => bill.StateTerrOrgAbbrev === stateAbbr);
            const stateEnacted = stateBills.filter(bill => bill.CurrentDisposition === 'Enacted');
            const statePending = stateBills.filter(bill => bill.CurrentDisposition === 'Pending');
            
            // Calculate regional average for comparison
            const stateRegion = stateBills[0]?.Region;
            const regionalBills = stateRegion ? allData.filter(bill => bill.Region === stateRegion) : [];
            const regionalStates = new Set(regionalBills.map(bill => bill.StateTerrOrgAbbrev));
            const regionalAverage = regionalStates.size > 0 ? Math.round(regionalBills.length / regionalStates.size) : 0;
            
            // Get covered categories and policy focus areas
            const coveredCategories = new Set();
            const policyFocusAreas = {};
            stateEnacted.forEach(bill => {
                if (bill.CategoryNames) {
                    bill.CategoryNames.split(',').forEach(cat => coveredCategories.add(cat.trim()));
                }
                // Analyze policy focus
                const focusAreas = analyzePolicyFocus(bill.Title || '');
                focusAreas.forEach(focus => {
                    policyFocusAreas[focus] = (policyFocusAreas[focus] || 0) + 1;
                });
            });
            
            // Define the 8 core categories (you may need to adjust these based on actual data)
            const coreCategories = [
                'Clinical Skill-Building',
                'Patient Rights and Protections', 
                'Payment',
                'Pediatric Palliative and Hospice Care',
                'Public Awareness',
                'Quality/Standards',
                'Telehealth',
                'Workforce'
            ];
            
            // Find most recent activity
            const recentBills = stateBills
                .filter(bill => bill.LastStatusActionDate)
                .sort((a, b) => new Date(b.LastStatusActionDate) - new Date(a.LastStatusActionDate));
            const mostRecentDate = recentBills[0]?.LastStatusActionDate || 'N/A';
            
            // Find similar states (same region, similar number of enacted bills)
            const similarStates = [];
            if (stateRegion) {
                const regionalStateCounts = {};
                regionalBills.forEach(bill => {
                    if (bill.StateTerrOrgAbbrev !== stateAbbr) {
                        regionalStateCounts[bill.StateTerrOrgAbbrev] = (regionalStateCounts[bill.StateTerrOrgAbbrev] || 0) + 1;
                    }
                });
                
                const targetCount = stateEnacted.length;
                Object.entries(regionalStateCounts)
                    .filter(([state, count]) => Math.abs(count - targetCount) <= 3)
                    .sort((a, b) => Math.abs(a[1] - targetCount) - Math.abs(b[1] - targetCount))
                    .slice(0, 3)
                    .forEach(([state]) => similarStates.push(state));
            }
            
            // Calculate success rate and policy innovation score
            const successRate = stateBills.length > 0 ? Math.round((stateEnacted.length / stateBills.length) * 100) : 0;
            const innovationScore = Object.keys(policyFocusAreas).length;
            const topPolicyFocus = Object.entries(policyFocusAreas)
                .sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';
            
            // Build scorecard HTML
            const scorecardHTML = `
                <div class="scorecard-metric">
                    <span class="scorecard-label">Policy Success Rate</span>
                    <span class="scorecard-value">${successRate}%</span>
                </div>
                <div class="scorecard-metric">
                    <span class="scorecard-label">Enacted Policies</span>
                    <span class="scorecard-value">${stateEnacted.length}</span>
                </div>
                <div class="scorecard-metric">
                    <span class="scorecard-label">Policy Innovation Score</span>
                    <span class="scorecard-value">${innovationScore} focus areas</span>
                </div>
                <div class="scorecard-metric">
                    <span class="scorecard-label">Top Policy Focus</span>
                    <span class="scorecard-value">${topPolicyFocus}</span>
                </div>
                <div class="scorecard-metric">
                    <span class="scorecard-label">Most Recent Activity</span>
                    <span class="scorecard-value">${mostRecentDate}</span>
                </div>
                ${similarStates.length > 0 ? `
                <div class="scorecard-metric">
                    <span class="scorecard-label">Similar States (for learning)</span>
                    <span class="scorecard-value">${similarStates.join(', ')}</span>
                </div>
                ` : ''}
                
                <div class="category-coverage">
                    <h4>Policy Approach Strengths</h4>
                    <div style="margin-bottom: 15px;">
                        ${Object.entries(policyFocusAreas)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 4)
                            .map(([focus, count]) => 
                                `<span class="model-bill-focus">${focus} (${count})</span>`
                            ).join(' ')}
                    </div>
                </div>
                
                <div class="category-coverage">
                    <h4>Policy Category Coverage</h4>
                    <div class="category-grid">
                        ${coreCategories.map(category => {
                            const isCovered = Array.from(coveredCategories).some(covered => 
                                covered.toLowerCase().includes(category.toLowerCase().split(' ')[0])
                            );
                            return `
                                <div class="category-item ${isCovered ? 'category-covered' : 'category-missing'}">
                                    ${category}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Update scorecard content
            document.getElementById('scorecardStateTitle').textContent = `${stateName} (${stateAbbr})`;
            document.getElementById('scorecardContent').innerHTML = scorecardHTML;
            
            // Show scorecard
            document.getElementById('scorecardOverlay').style.display = 'block';
            document.getElementById('stateScorecard').style.display = 'block';
        }
        
        function exportCurrentView() {
            // Create CSV content from filtered data
            const headers = ['State', 'Bill Number', 'Title', 'Categories', 'Disposition', 'Intro Date', 'Last Action', 'Policy Focus Areas'];
            
            const csvRows = [headers.join(',')];
            
            filteredData.forEach(bill => {
                const focusAreas = analyzePolicyFocus(bill.Title || '').join('; ');
                const row = [
                    `"${bill.StateTerrOrgAbbrev || ''}"`,
                    `"${bill.Number || ''}"`,
                    `"${(bill.Title || '').replace(/"/g, '""')}"`,
                    `"${bill.CategoryNames || ''}"`,
                    `"${bill.CurrentDisposition || ''}"`,
                    `"${bill.IntroDate || ''}"`,
                    `"${bill.LastStatusActionDate || ''}"`,
                    `"${focusAreas}"`
                ];
                csvRows.push(row.join(','));
            });
            
            // Create and download file
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `palliative-care-policies-${new Date().toISOString().split('T')[0]}.csv`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function showPolicyGaps() {
            // Analyze which successful policy approaches each state hasn't tried
            const stateEnactedFocus = {};
            const allSuccessfulFocus = new Set();
            
            // Collect all successful policy focus areas
            allData.filter(bill => bill.CurrentDisposition === 'Enacted').forEach(bill => {
                const state = bill.StateTerrOrgAbbrev;
                if (!stateEnactedFocus[state]) {
                    stateEnactedFocus[state] = new Set();
                }
                
                const focusAreas = analyzePolicyFocus(bill.Title || '');
                focusAreas.forEach(focus => {
                    stateEnactedFocus[state].add(focus);
                    allSuccessfulFocus.add(focus);
                });
            });
            
            // Find gaps for each state
            const gapAnalysis = [];
            Object.keys(stateEnactedFocus).forEach(state => {
                const stateFocus = stateEnactedFocus[state];
                const gaps = [...allSuccessfulFocus].filter(focus => !stateFocus.has(focus));
                if (gaps.length > 0) {
                    gapAnalysis.push({
                        state: state,
                        gaps: gaps,
                        gapCount: gaps.length,
                        coverageScore: Math.round(((allSuccessfulFocus.size - gaps.length) / allSuccessfulFocus.size) * 100)
                    });
                }
            });
            
            // Sort by most gaps (biggest opportunities)
            gapAnalysis.sort((a, b) => b.gapCount - a.gapCount);
            
            // Display results
            const gapHTML = `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #856404; margin-bottom: 15px;">Policy Opportunity Analysis</h4>
                    <p style="color: #856404; margin-bottom: 20px;">States with the most policy gaps represent the biggest opportunities for advocacy and policy development.</p>
                    
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${gapAnalysis.slice(0, 10).map(analysis => `
                            <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong>${analysis.state}</strong>
                                    <span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${analysis.gapCount} gaps (${analysis.coverageScore}% coverage)
                                    </span>
                                </div>
                                <div style="font-size: 0.9em; color: #666;">
                                    <strong>Missing successful approaches:</strong> ${analysis.gaps.slice(0, 5).join(', ')}${analysis.gaps.length > 5 ? '...' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="preset-btn" onclick="document.getElementById('tableContainer').innerHTML = document.getElementById('tableContainer').innerHTML;">Close Analysis</button>
                    </div>
                </div>
            `;
            
            document.getElementById('tableContainer').innerHTML = gapHTML + document.getElementById('tableContainer').innerHTML;
        }
        
        function closeScorecard() {
            document.getElementById('scorecardOverlay').style.display = 'none';
            document.getElementById('stateScorecard').style.display = 'none';
        }
        
        // Initialize on page load
        loadData();
    </script>
</body>
</html>